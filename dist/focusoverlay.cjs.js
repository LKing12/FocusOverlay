/* Focus Overlay - v0.9.5
* https://github.com/MauriceMahan/FocusOverlay
* Copyright (c) 2019 Maurice Mahan. Licensed MIT */
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}function _extends(){return(_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t}).apply(this,arguments)}function extend(){for(var t,e,i,n=arguments[0]||{},o=1,s=arguments.length;o<s;o++)if(null!==(t=arguments[o]))for(e in t)n!==(i=t[e])&&void 0!==i&&(n[e]=i);return n}function getAbsoluteBoundingRect(t){var e=document,i=window,n=e.body,o=void 0!==i.pageXOffset?i.pageXOffset:(e.documentElement||n.parentNode||n).scrollLeft,s=void 0!==i.pageYOffset?i.pageYOffset:(e.documentElement||n.parentNode||n).scrollTop,a=t.getBoundingClientRect();if(t!==n)for(var r=t.parentNode;r!==n&&r;)o+=r.scrollLeft,s+=r.scrollTop,r=r.parentNode;return{bottom:a.bottom+s,height:a.height,left:a.left+o,right:a.right+o,top:a.top+s,width:a.width}}function whichTransitionEvent(){var t=document.createElement("fakeelement"),e={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(var i in e)if(void 0!==t.style[i])return e[i]}Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(t,e){if(null==this)throw new TypeError('"this" is null or not defined');var i=Object(this),n=i.length>>>0;if(0===n)return!1;for(var o,s,a=0|e,r=Math.max(a>=0?a:n-Math.abs(a),0);r<n;){if((o=i[r])===(s=t)||"number"==typeof o&&"number"==typeof s&&isNaN(o)&&isNaN(s))return!0;r++}return!1}});var FocusOverlay=function(){function t(e,i){_classCallCheck(this,t),this.active=!1,this.scopedEl,this.focusBox,this.previousTarget,this.nextTarget,this.timeout=0,this.inScope=!1,this.transitionEvent=whichTransitionEvent(),this.options=extend({class:"focus-overlay",activeClass:"focus-overlay-active",animatingClass:"focus-overlay-animating",targetClass:"focus-overlay-target",zIndex:9001,duration:500,inactiveAfterDuration:!1,triggerKeys:[9,36,37,38,39,40,13,32,16,17,18,27],inactiveOnNonTriggerKey:!0,inactiveOnClick:!0,alwaysActive:!1,watchTransitionEnd:!0,onInit:function(){},onBeforeMove:function(){},onAfterMove:function(){},onDestroy:function(){}},i||{}),e instanceof Element?this.scopedEl=e:"string"==typeof e||e instanceof String?this.scopedEl=document.querySelector(e):this.scopedEl=document.querySelector("body"),this.onKeyDownHandler=this.onKeyDownHandler.bind(this),this.onFocusHandler=this.onFocusHandler.bind(this),this.moveFocusBox=this.moveFocusBox.bind(this),this.stop=this.stop.bind(this),this.init()}return _createClass(t,[{key:"init",value:function(){this.options.alwaysActive?(this.active=!0,window.addEventListener("focusin",this.onFocusHandler,!0)):(window.addEventListener("keydown",this.onKeyDownHandler,!1),this.options.inactiveOnClick&&window.addEventListener("mousedown",this.stop,!1)),this._createFocusBox(),this.options.onInit(this)}},{key:"onKeyDownHandler",value:function(t){var e=this,i=t.which;this.options.triggerKeys.includes(i)?(!1===this.active&&(this.active=!0,window.addEventListener("focusin",this.onFocusHandler,!0)),setTimeout(function(){var t=document.activeElement;t instanceof HTMLIFrameElement&&e.scopedEl.contains(t)&&!0===e.active&&e.moveFocusBox(t)},5)):this.options.inactiveOnNonTriggerKey&&this.stop()}},{key:"_createFocusBox",value:function(){this.focusBox=document.createElement("div"),this.focusBox.setAttribute("aria-hidden","true"),this.focusBox.classList.add(this.options.class),_extends(this.focusBox.style,{position:"absolute",zIndex:this.options.zIndex,pointerEvents:"none"}),this.scopedEl.insertAdjacentElement("beforeend",this.focusBox)}},{key:"_cleanup",value:function(){null!=this.nextTarget&&(this.previousTarget=this.nextTarget,this.previousTarget.classList.remove(this.options.targetClass),this.previousTarget.removeEventListener(this.transitionEvent,this.moveFocusBox))}},{key:"onFocusHandler",value:function(t){var e=t.target;if(this._cleanup(),this.scopedEl.contains(e)){var i=this.nextTarget;if(this.inScope=!0,null!==e.getAttribute("data-focus")){var n=e.getAttribute("data-focus");this.nextTarget=document.querySelector("[data-focus='".concat(n,"']"))}else if(null!==e.getAttribute("data-focus-label")){var o=document.querySelector("[for='".concat(e.id,"']"));null===o&&(o=e.closest("label")),this.nextTarget=o}else{if(null!==e.getAttribute("data-focus-ignore"))return;this.nextTarget=e}clearTimeout(this.timeout),this.transitionEvent&&this.options.watchTransitionEnd&&this.nextTarget.addEventListener(this.transitionEvent,this.moveFocusBox),this.options.onBeforeMove(i,this.nextTarget,this),this.moveFocusBox(this.nextTarget)}else this.options.alwaysActive?this.inScope=!1:(this.inScope=!1,this.stop())}},{key:"stop",value:function(){this.active=!1,window.removeEventListener("focusin",this.onFocusHandler,!0),this._cleanup(),this.focusBox.classList.remove(this.options.activeClass)}},{key:"moveFocusBox",value:function(t){var e=this;if(t instanceof Event&&(t=document.activeElement),t.classList.add(this.options.targetClass),document.body.contains(t)&&t instanceof Element){var i=getAbsoluteBoundingRect(t),n="".concat(i.width,"px"),o="".concat(i.height,"px"),s="".concat(i.left,"px"),a="".concat(i.top,"px");this.focusBox.classList.add(this.options.animatingClass),this.focusBox.classList.add(this.options.activeClass),_extends(this.focusBox.style,{width:n,height:o,left:s,top:a}),this.timeout=setTimeout(function(){e.focusBox.classList.remove(e.options.animatingClass),e.options.inactiveAfterDuration&&e.focusBox.classList.remove(e.options.activeClass),e.options.onAfterMove(e.previousTarget,t,e)},this.options.duration)}else this._cleanup()}},{key:"destroy",value:function(){this.focusBox.parentNode.removeChild(this.focusBox),null!=this.previousTarget&&this.previousTarget.classList.remove(this.options.targetClass),null!=this.nextTarget&&this.nextTarget.classList.remove(this.options.targetClass),window.removeEventListener("focusin",this.onFocusHandler,!0),window.removeEventListener("keydown",this.onKeyDownHandler,!1),window.removeEventListener("mousedown",this.stop,!1),this.options.onDestroy(this)}}]),t}();module.exports=FocusOverlay;
