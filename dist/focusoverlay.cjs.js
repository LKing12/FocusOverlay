/* Focus Overlay - v0.9.5
* https://github.com/MauriceMahan/FocusOverlay
* Copyright (c) 2019 Maurice Mahan. Licensed MIT */
"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _extends(){return(_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t}).apply(this,arguments)}function _readOnlyError(t){throw new Error('"'+t+'" is read-only')}function extend(){for(var t,e,n,i=arguments[0]||{},o=1,s=arguments.length;o<s;o++)if(null!==(t=arguments[o]))for(e in t)i!==(n=t[e])&&void 0!==n&&(i[e]=n);return i}function getAbsoluteBoundingRect(t){var e=document,n=window,i=e.body,o=void 0!==n.pageXOffset?n.pageXOffset:(e.documentElement||i.parentNode||i).scrollLeft,s=void 0!==n.pageYOffset?n.pageYOffset:(e.documentElement||i.parentNode||i).scrollTop,r=t.getBoundingClientRect();if(t!==i)for(var a=t.parentNode;a!==i&&a;)o+=a.scrollLeft,s+=a.scrollTop,a=a.parentNode;return{bottom:r.bottom+s,height:r.height,left:r.left+o,right:r.right+o,top:r.top+s,width:r.width}}function whichTransitionEvent(){var t=document.createElement("fakeelement"),e={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(var n in e)if(void 0!==t.style[n])return e[n]}function triggerEvent(t,e,n){var i=new CustomEvent(e,{detail:{data:n}});return t.dispatchEvent(i)}!function(){if("undefined"!=typeof window)try{var t=new window.CustomEvent("test",{cancelable:!0});if(t.preventDefault(),!0!==t.defaultPrevented)throw new Error("Could not prevent default")}catch(t){var e=function(t,e){var n,i;return(e=e||{}).bubbles=!!e.bubbles,e.cancelable=!!e.cancelable,(n=document.createEvent("CustomEvent")).initCustomEvent(t,e.bubbles,e.cancelable,e.detail),i=n.preventDefault,n.preventDefault=function(){i.call(this);try{Object.defineProperty(this,"defaultPrevented",{get:function(){return!0}})}catch(t){this.defaultPrevented=!0}},n};e.prototype=window.Event.prototype,window.CustomEvent=e}}(),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(t,e){if(null==this)throw new TypeError('"this" is null or not defined');var n=Object(this),i=n.length>>>0;if(0===i)return!1;for(var o,s,r=0|e,a=Math.max(r>=0?r:i-Math.abs(r),0);a<i;){if((o=n[a])===(s=t)||"number"==typeof o&&"number"==typeof s&&isNaN(o)&&isNaN(s))return!0;a++}return!1}});var FocusOverlay=function(){function t(e,n){_classCallCheck(this,t),this.active=!1,this.scopedEl,this.focusBox,this.previousTarget,this.nextTarget,this.timeout=0,this.inScope=!1,this.transitionEvent=whichTransitionEvent(),this.options=extend({id:"focus-overlay",activeClass:"focus-overlay-active",animatingClass:"focus-overlay-animating",targetClass:"focus-overlay-target",zIndex:9001,duration:500,inactiveAfterDuration:!1,triggerKeys:[9,36,37,38,39,40,13,32,16,17,18,27],inactiveOnNonTriggerKey:!0,inactiveOnClick:!0,alwaysActive:!1,watchTransitionEnd:!0},n||{}),e instanceof Element?this.scopedEl=e:"string"==typeof e||e instanceof String?this.scopedEl=document.querySelector(e):this.scopedEl=document.querySelector("body"),this.onKeyDownHandler=this.onKeyDownHandler.bind(this),this.onFocusHandler=this.onFocusHandler.bind(this),this.moveFocusBox=this.moveFocusBox.bind(this),this.stop=this.stop.bind(this),this.init()}return _createClass(t,[{key:"init",value:function(){this.options.alwaysActive?(this.active=!0,window.addEventListener("focusin",this.onFocusHandler,!0)):(window.addEventListener("keydown",this.onKeyDownHandler,!1),this.options.inactiveOnClick&&window.addEventListener("mousedown",this.stop,!1)),this.createFocusBox(),triggerEvent(this.scopedEl,"foInit",this)}},{key:"onKeyDownHandler",value:function(t){var e=this,n=t.which;this.options.triggerKeys.includes(n)?(!1===this.active&&(this.active=!0,window.addEventListener("focusin",this.onFocusHandler,!0)),setTimeout(function(){var t=document.activeElement;t instanceof HTMLIFrameElement&&e.scopedEl.contains(t)&&!0===e.active&&e.moveFocusBox(t)},5)):this.options.inactiveOnNonTriggerKey&&this.stop()}},{key:"createFocusBox",value:function(){this.focusBox=document.createElement("div"),this.focusBox.setAttribute("aria-hidden","true"),this.focusBox.setAttribute("id",this.options.id),_extends(this.focusBox.style,{position:"absolute",zIndex:this.options.zIndex,pointerEvents:"none"}),this.scopedEl.insertAdjacentElement("beforeend",this.focusBox)}},{key:"cleanup",value:function(){null!=this.nextTarget&&(this.previousTarget=this.nextTarget,this.previousTarget.classList.remove(this.options.targetClass),this.previousTarget.removeEventListener(this.transitionEvent,this.moveFocusBox))}},{key:"onFocusHandler",value:function(t){var e=t.target;if(this.cleanup(),this.scopedEl.contains(e)){this.nextTarget,this.previousTarget;if(this.inScope=!0,null!==e.getAttribute("data-focus")){var n=e.getAttribute("data-focus");this.nextTarget=document.querySelector("[data-focus='".concat(n,"']"))}else if(null!==e.getAttribute("data-focus-label")){var i=document.querySelector("[for='".concat(e.id,"']"));i.length<1&&(_readOnlyError("associatedEl"),i=e.closest("label")),this.nextTarget=i}else{if(null!==e.getAttribute("data-focus-ignore"))return;this.nextTarget=e}clearTimeout(this.timeout),this.transitionEvent&&this.options.watchTransitionEnd&&this.nextTarget.addEventListener(this.transitionEvent,this.moveFocusBox),this.moveFocusBox(this.nextTarget)}else this.options.alwaysActive?this.inScope=!1:(this.inScope=!1,this.stop())}},{key:"stop",value:function(){this.active=!1,window.removeEventListener("focusin",this.onFocusHandler,!0),this.cleanup(),this.focusBox.classList.remove(this.options.activeClass)}},{key:"moveFocusBox",value:function(t){var e=this;if(t instanceof Event&&(t=document.activeElement),t.classList.add(this.options.targetClass),document.body.contains(t)&&t instanceof Element){var n=getAbsoluteBoundingRect(t),i="".concat(n.width,"px"),o="".concat(n.height,"px"),s="".concat(n.left,"px"),r="".concat(n.top,"px");this.focusBox.classList.add(this.options.animatingClass),this.focusBox.classList.add(this.options.activeClass),_extends(this.focusBox.style,{width:i,height:o,left:s,top:r}),this.timeout=setTimeout(function(){e.focusBox.classList.remove(e.options.animatingClass),e.options.inactiveAfterDuration&&e.focusBox.classList.remove(e.options.activeClass)},this.options.duration)}else this.cleanup()}},{key:"destroy",value:function(){return this.focusBox.remove(),null!=this.previousTarget&&this.previousTarget.classList.remove(this.options.targetClass),null!=this.nextTarget&&this.nextTarget.classList.remove(this.options.targetClass),window.removeEventListener("focusin",this.onFocusHandler,!0),window.removeEventListener("keydown",this.onKeyDownHandler,!1),window.removeEventListener("mousedown",this.stop,!1),!0}}]),t}();module.exports=FocusOverlay;
